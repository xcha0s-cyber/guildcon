{% extends "base.html" %}

{% block title %}Tournament Bracket - Guild Con CTF{% endblock %}

{% block content %}
<h2 style="color: #00d4aa; text-align: center; margin-bottom: 3rem;">CTF Tournament Bracket</h2>

{% if not matches %}
<div style="text-align: center; padding: 4rem;">
    <h3 style="color: #00d4aa;">Tournament Not Started</h3>
    <p>Check back on November 22, 2025 for live bracket updates!</p>
</div>
{% else %}

<div class="bracket">
    <!-- Quarterfinals -->
    <div class="round">
        <h3 style="color: #00d4aa; text-align: center;">Quarterfinals</h3>
        {% for match in matches if match.round == 'Quarterfinals' %}
        {% set team1 = teams|selectattr('id', 'equalto', match.team1_id)|first %}
        {% set team2 = teams|selectattr('id', 'equalto', match.team2_id)|first %}
        <div class="match {{ 'active' if not match.winner_id else '' }}">
            <div class="match-header">Match {{ loop.index }}</div>
            <div class="team {{ 'winner' if match.winner_id == match.team1_id else '' }}">
                <span>{{ team1.name if team1 else 'TBD' }}</span>
                <span class="score">{{ match.team1_score }}</span>
            </div>
            <div class="team {{ 'winner' if match.winner_id == match.team2_id else '' }}">
                <span>{{ team2.name if team2 else 'TBD' }}</span>
                <span class="score">{{ match.team2_score }}</span>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Semifinals -->
    <div class="round">
        <h3 style="color: #00d4aa; text-align: center;">Semifinals</h3>
        {% for match in matches if match.round == 'Semifinals' %}
        {% set team1 = teams|selectattr('id', 'equalto', match.team1_id)|first %}
        {% set team2 = teams|selectattr('id', 'equalto', match.team2_id)|first %}
        <div class="match {{ 'active' if (match.team1_id and match.team2_id and not match.winner_id) else '' }}">
            <div class="match-header">Semifinal {{ loop.index }}</div>
            <div class="team {{ 'winner' if match.winner_id == match.team1_id else '' }}">
                <span>{{ team1.name if team1 else 'Winner QF ' + ((loop.index0 * 2) + 1)|string }}</span>
                <span class="score">{{ match.team1_score if team1 else '-' }}</span>
            </div>
            <div class="team {{ 'winner' if match.winner_id == match.team2_id else '' }}">
                <span>{{ team2.name if team2 else 'Winner QF ' + ((loop.index0 * 2) + 2)|string }}</span>
                <span class="score">{{ match.team2_score if team2 else '-' }}</span>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Finals -->
    <div class="round">
        <h3 style="color: #00d4aa; text-align: center;">Finals</h3>
        {% for match in matches if match.round == 'Finals' %}
        {% set team1 = teams|selectattr('id', 'equalto', match.team1_id)|first %}
        {% set team2 = teams|selectattr('id', 'equalto', match.team2_id)|first %}
        <div class="match {{ 'active' if (match.team1_id and match.team2_id and not match.winner_id) else '' }}">
            <div class="match-header">Grand Final</div>
            <div class="team {{ 'winner' if match.winner_id == match.team1_id else '' }}">
                <span>{{ team1.name if team1 else 'Winner SF 1' }}</span>
                <span class="score">{{ match.team1_score if team1 else '-' }}</span>
            </div>
            <div class="team {{ 'winner' if match.winner_id == match.team2_id else '' }}">
                <span>{{ team2.name if team2 else 'Winner SF 2' }}</span>
                <span class="score">{{ match.team2_score if team2 else '-' }}</span>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Champion -->
    <div class="round">
        <h3 style="color: #ffd700; text-align: center;">üèÜ Champion</h3>
        {% set final = matches|selectattr('round', 'equalto', 'Finals')|first %}
        {% if final and final.winner_id %}
        {% set champion = teams|selectattr('id', 'equalto', final.winner_id)|first %}
        <div class="match" style="border-color: #ffd700;">
            <div class="team winner" style="background: rgba(255,215,0,0.2); border-color: #ffd700;">
                <span style="font-size: 1.2rem;">{{ champion.name }}</span>
            </div>
        </div>
        {% else %}
        <div class="match">
            <div class="team">
                <span>TBD</span>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Auto-refresh for live updates -->
<p style="text-align: center; margin-top: 2rem; color: #666;">
    This page auto-refreshes every 30 seconds
</p>

{% endif %}

{% if not public %}
<div style="text-align: center; margin-top: 2rem;">
    <a href="/admin" class="btn">Back to Admin</a>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// Auto-refresh every 30 seconds during tournament
{% if matches %}
setTimeout(() => location.reload(), 30000);
{% endif %}
</script>
{% endblock %}